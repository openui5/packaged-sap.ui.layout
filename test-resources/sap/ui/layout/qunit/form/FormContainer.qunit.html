<!DOCTYPE HTML>
<!--
  Tested control/class: sap.ui.layout.form.FormContainer
  Author: SAP
-->

<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<script src="../../shared-config.js"></script>
	<script id="sap-ui-bootstrap"
		src="../../../../../../resources/sap-ui-core.js"
		data-sap-ui-noConflict="true"
		data-sap-ui-libs="sap.ui.layout, sap.m"
		data-sap-ui-language="en-US">
	</script>
	<title>QUnit Test for FormContainer</title>
	<link rel="shortcut icon" type="image/x-icon" href="../../images/controls/sap.ui.layout.form.FormContainer.gif">
	<link rel="stylesheet" href="../../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
	<script src="../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script src="../../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script src="../../../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
	<script src="../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script src="../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script src="../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

	<script>
	(function(QUnit, sinon) {
		'use strict';

		jQuery.sap.require("sap.ui.layout.form.FormContainer");
		jQuery.sap.require("sap.ui.layout.form.FormElement");
		jQuery.sap.require("sap.ui.core.Title");
		jQuery.sap.require("sap.m.Toolbar");

		var oFormContainer;

		function initTest() {
			oFormContainer = new sap.ui.layout.form.FormContainer("FC1");
		}

		function afterTest() {
			if (oFormContainer) {
				oFormContainer.destroy();
				oFormContainer = undefined;
			}
		}

		QUnit.module("Instance", {
			beforeEach: initTest,
			afterEach: afterTest
		});

		QUnit.test("Shall be instantiable", function(assert) {
			assert.ok(oFormContainer, "FormContainer is created");
		});

		QUnit.module("visible", {
			beforeEach: initTest,
			afterEach: afterTest
		});

		QUnit.test("isVisible / getVisible", function(assert) {
			assert.ok(oFormContainer.getVisible(), "FormContainer visible per default");
			assert.ok(oFormContainer.isVisible(), "FormContainer is visible for rendering");

			oFormContainer.setVisible(false);

			assert.notOk(oFormContainer.getVisible(), "FormContainer not visible");
			assert.notOk(oFormContainer.isVisible(), "FormContainer not visible for rendering");
		});

		QUnit.module("Expander", {
			beforeEach: initTest,
			afterEach: afterTest
		});

		QUnit.test("Expander created", function(assert) {
			oFormContainer.setExpandable(true);
			var oButton = oFormContainer.getAggregation("_expandButton");

			// as button is loaded async, check if already there and rendered, if not, start test async
			if (sap.ui.require("sap/m/Button") && oButton) {
				assert.ok(oButton, "expander created");
				assert.equal(oButton.getType(), sap.m.ButtonType.Transparent, "Button type");
			} else {
				var fnDone = assert.async();
				sap.ui.require(["sap/m/Button"], function() {
					oButton = oFormContainer.getAggregation("_expandButton");
					assert.ok(oButton, "expander created");
					assert.equal(oButton.getType(), sap.m.ButtonType.Transparent, "Button type");
					fnDone();
				});
			}
		});

		QUnit.test("Expander default", function(assert) {
			// test default after button is loaded, otherwise the button ciuld be empty because of async loading
			var oButton = oFormContainer.getAggregation("_expandButton");
			assert.notOk(oButton, "No expander created per default");
		});

		QUnit.test("destroy button", function(assert) {
			oFormContainer.setExpandable(true);
			var oButton = oFormContainer.getAggregation("_expandButton");
			var sButtonId = oButton.getId();

			oFormContainer.destroy();
			oFormContainer = undefined;
			assert.notOk(sap.ui.getCore().byId(sButtonId), "Button destroyed");

			initTest();
		});

		QUnit.test("Expander icon", function(assert) {
			oFormContainer.setExpanded(false);
			oFormContainer.setExpandable(true);
			var oButton = oFormContainer.getAggregation("_expandButton");

			assert.equal(oButton.getIcon(), "sap-icon://expand-group", "Expander Icon");
			assert.equal(oButton.getTooltip(), "Expand", "Expander Tooltip");

			oFormContainer.setExpanded(true);
			assert.equal(oButton.getIcon(), "sap-icon://collapse-group", "Expander Icon");
			assert.equal(oButton.getTooltip(), "Collapse", "Expander Tooltip");
		});

		QUnit.test("Expander press", function(assert) {
			oFormContainer.setExpandable(true);
			var oButton = oFormContainer.getAggregation("_expandButton");
			var bCalled = false;
			var oForm = {
					toggleContainerExpanded: function() {
						bCalled = true;
						}
			};

			// simulate Form
			sinon.stub(oFormContainer, "getParent", function() {return oForm;});

			// simulate button click
			oButton.firePress();
			assert.ok(bCalled, "toggleContainerExpanded called on Form");
			assert.notOk(oFormContainer.getExpanded(), "FormContainer not expanded");
		});

		QUnit.module("Title", {
			beforeEach: initTest,
			afterEach: afterTest
		});

		QUnit.test("Title as string", function(assert) {
			oFormContainer.setTitle("Test");
			assert.equal(oFormContainer.getTitle(), "Test", "Title set");

			oFormContainer.destroyTitle();
			assert.notOk(oFormContainer.getTitle(), "no Title set");
		});

		QUnit.test("Title as object", function(assert) {
			var oTitle = new sap.ui.core.Title("T1", {text: "Test"})
			oFormContainer.setTitle(oTitle);
			assert.equal(oFormContainer.getTitle(), oTitle, "Title set");

			oFormContainer.destroyTitle();
			assert.notOk(oFormContainer.getTitle(), "no Title set");
		});

		QUnit.module("Toolbar", {
			beforeEach: initTest,
			afterEach: afterTest
		});

		QUnit.test("Toolbar set", function(assert) {
			var oToolbar = new sap.m.Toolbar("TB1");
			oFormContainer.setToolbar(oToolbar);
			assert.equal(oFormContainer.getToolbar(), oToolbar, "Toolbar set");
			assert.equal(oToolbar.getActiveDesign(), sap.m.ToolbarDesign.Transparent, "Toolbar Auto-design set");
			assert.equal(oToolbar.getDesign(), sap.m.ToolbarDesign.Auto, "Toolbar design not changed");
		});

		QUnit.module("FormElements", {
			beforeEach: initTest,
			afterEach: afterTest
		});

		QUnit.test("addFormElement", function(assert) {
			var oFormElement1 = new sap.ui.layout.form.FormElement("FE1");
			var oFormElement2 = new sap.ui.layout.form.FormElement("FE2");
			oFormContainer.addFormElement(oFormElement1);
			oFormContainer.addFormElement(oFormElement2);
			var aFormElements = oFormContainer.getFormElements();

			assert.equal(aFormElements.length, 2, "2 FormElements added");
			assert.equal(aFormElements[0].getId(), "FE1", "first FormElement");
			assert.equal(aFormElements[1].getId(), "FE2", "second FormElement");
			assert.equal(oFormContainer.indexOfFormElement(oFormElement2), 1, "Index of FormElement");
		});

		QUnit.test("insertFormElement", function(assert) {
			var oFormElement1 = new sap.ui.layout.form.FormElement("FE1");
			var oFormElement2 = new sap.ui.layout.form.FormElement("FE2");
			oFormContainer.insertFormElement(oFormElement1, 0);
			oFormContainer.insertFormElement(oFormElement2, 0);
			var aFormElements = oFormContainer.getFormElements();

			assert.equal(aFormElements.length, 2, "2 FormElements added");
			assert.equal(aFormElements[0].getId(), "FE2", "first FormElement");
			assert.equal(aFormElements[1].getId(), "FE1", "second FormElement");
			assert.equal(oFormContainer.indexOfFormElement(oFormElement2), 0, "Index of FormElement");
		});

		QUnit.test("removeFormElement", function(assert) {
			var oFormElement1 = new sap.ui.layout.form.FormElement("FE1");
			var oFormElement2 = new sap.ui.layout.form.FormElement("FE2");
			oFormContainer.addFormElement(oFormElement1);
			oFormContainer.addFormElement(oFormElement2);
			var oRemoved = oFormContainer.removeFormElement(oFormElement1);
			var aFormElements = oFormContainer.getFormElements();

			assert.equal(aFormElements.length, 1, "1 FormElement assigned");
			assert.equal(oRemoved, oFormElement1, "Removed FormElement");
			oFormElement1.destroy();
		});

		QUnit.test("removeAllFormElements", function(assert) {
			var oFormElement1 = new sap.ui.layout.form.FormElement("FE1");
			var oFormElement2 = new sap.ui.layout.form.FormElement("FE2");
			oFormContainer.addFormElement(oFormElement1);
			oFormContainer.addFormElement(oFormElement2);
			var aRemoved = oFormContainer.removeAllFormElements();
			var aFormElements = oFormContainer.getFormElements();

			assert.equal(aFormElements.length, 0, "0 FormElement assigned");
			assert.equal(aRemoved.length, 2, "2 FormElements removed");
			oFormElement1.destroy();
			oFormElement2.destroy();
		});

		QUnit.test("destroyFormElements", function(assert) {
			var oFormElement1 = new sap.ui.layout.form.FormElement("FE1");
			var oFormElement2 = new sap.ui.layout.form.FormElement("FE2");
			oFormContainer.addFormElement(oFormElement1);
			oFormContainer.addFormElement(oFormElement2);
			oFormContainer.destroyFormElements();
			var aFormElements = oFormContainer.getFormElements();

			assert.equal(aFormElements.length, 0, "0 FormElement assigned");
			assert.notOk(sap.ui.getCore().byId("FE1"), "FormElement1 destroyed");
			assert.notOk(sap.ui.getCore().byId("FE2"), "FormElement2 destroyed");
		});

		QUnit.module("other functions", {
			beforeEach: initTest,
			afterEach: afterTest
		});

		QUnit.test("_checkProperties", function(assert) {
			oFormContainer.setExpandable(true);
			assert.equal(oFormContainer._checkProperties(), 1, "error found")

			oFormContainer.setTitle("Test");
			assert.equal(oFormContainer._checkProperties(), 0, "no error found")
			oFormContainer.destroyTitle();

			var oToolbar = new sap.m.Toolbar("TB1");
			oFormContainer.setToolbar(oToolbar);
			assert.equal(oFormContainer._checkProperties(), 1, "error found")
		});

		QUnit.test("onLayoutDataChange", function(assert) {
			var bCalled = false;
			var oForm = {
					onLayoutDataChange: function() {
						bCalled = true;
						}
			};

			// simulate FormContainer
			sinon.stub(oFormContainer, "getParent", function() {return oForm;});

			oFormContainer.onLayoutDataChange();
			assert.ok(bCalled, "onLayoutDataChange called on Form");
		});

		QUnit.test("contentOnAfterRendering", function(assert) {
			var bCalled = false;
			var oFormElement;
			var oControl;
			var oForm = {
					contentOnAfterRendering: function(oFE, oC) {
						bCalled = true;
						oFormElement = oFE;
						oControl = oC;
						}
			};

			// simulate FormContainer
			sinon.stub(oFormContainer, "getParent", function() {return oForm;});

			oFormContainer.contentOnAfterRendering("1", "2");
			assert.ok(bCalled, "contentOnAfterRendering called on Form");
			assert.equal(oFormElement, "1", "used FormElement");
			assert.equal(oControl, "2", "used Control");
		});

		QUnit.test("getRenderedDomRef", function(assert) {
			assert.notOk(oFormContainer.getRenderedDomRef(), "no DOMRef as not asigned to Container");

			var oForm = {
					getContainerRenderedDomRef: function() {
						return "X";
						}
			};

			// simulate FormContainer
			sinon.stub(oFormContainer, "getParent", function() {return oForm;});

			assert.equal(oFormContainer.getRenderedDomRef(), "X", "Value returned from Form");
		});

		QUnit.test("getElementRenderedDomRef", function(assert) {
			assert.notOk(oFormContainer.getElementRenderedDomRef(), "no DOMRef as not asigned to Container");

			var oForm = {
					getElementRenderedDomRef: function() {
						return "X";
						}
			};

			// simulate FormContainer
			sinon.stub(oFormContainer, "getParent", function() {return oForm;});

			assert.equal(oFormContainer.getElementRenderedDomRef(), "X", "Value returned from Form");
		});

		QUnit.test("invalidateLabels", function(assert) {
			var oFormElement1 = new sap.ui.layout.form.FormElement("FE1");
			var oFormElement2 = new sap.ui.layout.form.FormElement("FE2");
			oFormContainer.addFormElement(oFormElement1);
			oFormContainer.addFormElement(oFormElement2);

			sinon.spy(oFormElement1, "invalidateLabel");
			sinon.spy(oFormElement2, "invalidateLabel");

			oFormContainer.invalidateLabels();
			assert.ok(oFormElement1.invalidateLabel.called, "invalidateLabel on FormElement1");
			assert.ok(oFormElement2.invalidateLabel.called, "invalidateLabel on FormElement2");
		});

	}(QUnit, sinon));
	</script>

</head>
<body class="sapUiBody">
	<div id="qunit"></div>
</body>
</html>
